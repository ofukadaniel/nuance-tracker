<!doctype html>
<html lang="en" class="h-full" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#071426" />
  <meta name="color-scheme" content="dark" />
  <title>Nuanced Performance Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root{ --bg:#071426; --card:#0B1F3A; --border:#143457; --muted:#0a2242; --muted2:#0a1b33; --text: rgba(191,219,254,0.85); --text-weak: rgba(191,219,254,0.65); }
    html[data-theme="light"]{ --bg:#f6f8fc; --card:#ffffff; --border:#c9d6ea; --muted:#e8effa; --muted2:#eef3fb; --text: rgba(15,23,42,0.92); --text-weak: rgba(15,23,42,0.70); }
    html,body{height:100%; background:var(--bg); color: var(--text); }
    .card{background:var(--card); border:1px solid var(--border);}
    .chip{border:1px solid var(--border); background:var(--muted2);}
    .chip-on{background:rgba(2,132,199,0.35); border-color:rgba(125,211,252,0.8);}
    .pen-on{background:rgba(220,38,38,0.35); border-color:rgba(252,165,165,0.8);}
    .btn{border:1px solid var(--border); background:var(--muted2);}
    .btn-primary{background:#0284c7; border-color:#38bdf8;}
    .tab-on{background:rgba(2,132,199,0.35); border-color:rgba(125,211,252,0.8);}
    input[type="range"]{ accent-color:#38bdf8; }
    .ring{ width:152px; height:152px; }
    .mono{ font-feature-settings:"tnum" 1, "lnum" 1; }
    .selected-outline{ outline:2px solid rgba(125,211,252,0.95); outline-offset:2px; }
    .bottom-nav{ position:fixed; left:0; right:0; bottom:0; background:rgba(7,20,38,0.92); border-top:1px solid rgba(20,52,87,0.95); backdrop-filter: blur(10px); z-index:50; }
    .deck-viewport{ overflow-x:hidden; overflow-y:visible; }
    .deck{ display:flex; width:100%; will-change:transform; transition: transform 260ms ease; }
    .deck > section{ width:100%; flex:0 0 100%; }
    .subtab-on{ background:rgba(34,197,94,0.18); border-color:rgba(134,239,172,0.65); }
    .table-input{ width:90px; background:var(--bg); border:1px solid var(--border); border-radius:10px; padding:6px 8px; color:var(--text); font-size:13px; text-align:right; }
    .table-input-wide{ width:220px; text-align:left; }
    .mini-btn{ border:1px solid var(--border); background:var(--muted2); border-radius:10px; padding:6px 10px; font-size:12px; font-weight:700; color:rgba(191,219,254,0.9); }
    .mini-danger{ background:rgba(220,38,38,0.35); border-color:rgba(252,165,165,0.8); color:#fff; }
    .results-sticky{ position: sticky; top: 10px; z-index: 30; }
  </style>
</head>

<body class="min-h-full">
  <div class="mx-auto max-w-6xl px-3 pb-28">
    <header class="pt-4 pb-3">
      <div class="flex items-center justify-between gap-3">
        <div class="text-sky-200 text-xl font-semibold">Nuanced Performance Tracker</div>
        <div class="flex gap-2">
          <button id="btnSave" class="btn btn-primary rounded-lg px-3 py-2 text-sm font-semibold text-white">Save Day</button>
          <button id="btnTheme" class="btn rounded-lg px-3 py-2 text-sm font-semibold">Theme</button>
        </div>
      </div>
      <div class="mt-3 grid grid-cols-1 md:grid-cols-3 gap-3">
        <div class="card rounded-xl p-3 flex justify-between items-center">
          <span class="text-cyan-200 text-sm font-semibold">Date</span>
          <input id="datePicker" type="date" class="rounded-lg px-3 py-2 text-sm bg-transparent border border-slate-700" />
        </div>
        <div class="card rounded-xl p-3 flex justify-between items-center">
          <span class="text-cyan-200 text-sm font-semibold">Mode</span>
          <div class="flex gap-2">
            <button data-mode="High" class="modeBtn chip rounded-lg px-3 py-2 text-sm">High</button>
            <button data-mode="Low" class="modeBtn chip rounded-lg px-3 py-2 text-sm">Low</button>
          </div>
        </div>
        <div class="card rounded-xl p-3 flex justify-between items-center">
          <span class="text-cyan-200 text-sm font-semibold">Personalize</span>
          <button id="btnPersonalize" class="btn rounded-lg px-3 py-2 text-sm">Off</button>
        </div>
      </div>
    </header>

    <main class="mt-3 deck-viewport">
      <div id="tabDeck" class="deck">
        <section id="tab-dashboard">
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-3">
            <div class="card rounded-xl p-4 lg:col-span-2">
              <div class="results-sticky">
                <div class="card rounded-xl p-3 bg-slate-900/50">
                  <div class="flex justify-around items-center">
                    <div id="perfRing" class="ring"></div>
                    <div id="recoveryRing" class="ring"></div>
                  </div>
                </div>
              </div>

              <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-3">
                <div class="card rounded-xl p-3">
                  <div class="flex justify-between items-center">
                    <span class="text-cyan-200 text-sm font-semibold">Sliders</span>
                    <button id="btnMoveSliders" class="btn rounded-lg px-3 py-2 text-xs">Move</button>
                  </div>
                  <div id="sliderInputs" class="mt-3 space-y-3"></div>
                </div>
                <div class="card rounded-xl p-3">
                  <div class="flex justify-between items-center">
                    <span class="text-cyan-200 text-sm font-semibold">Performance Indicators</span>
                    <button id="btnMovePerformance" class="btn rounded-lg px-3 py-2 text-xs">Move</button>
                  </div>
                  <div id="performanceToggles" class="mt-3 grid grid-cols-2 gap-2"></div>
                </div>
              </div>

              <div class="mt-3 card rounded-xl p-3">
                <div class="flex items-center justify-between gap-2">
                  <div>
                    <div class="text-cyan-200 text-sm font-semibold">Recovery Indicators</div>
                    <div class="text-blue-200/70 text-xs">Toggle recovery indicators.</div>
                  </div>
                  <button id="btnMoveRecovery" class="btn rounded-lg px-3 py-2 text-sm font-semibold">Move Selected</button>
                </div>
                <div id="recoveryToggles" class="mt-3 grid grid-cols-2 gap-2"></div>
              </div>

              <div class="mt-3 card rounded-xl p-3">
                <div class="flex justify-between">
                  <span class="text-cyan-200 text-sm font-semibold">Penalties</span>
                  <button id="btnMovePenalties" class="btn rounded-lg px-3 py-2 text-xs">Move</button>
                </div>
                <div id="penaltyToggles" class="mt-3 grid grid-cols-2 md:grid-cols-3 gap-2"></div>
              </div>
            </div>

            <div class="card rounded-xl p-4">
              <div class="text-sky-200 text-lg font-semibold mb-3">History</div>
              <tbody id="historyTable" class="text-xs"></tbody>
            </div>
          </div>
        </section>

        <section id="tab-builders">
          <div class="card rounded-xl p-4">
            <div class="flex justify-between">
              <span class="text-sky-200 text-lg font-semibold">Builders</span>
              <button id="btnUndo" class="btn rounded-lg px-3 py-2 text-sm">Undo</button>
            </div>
            
            <div class="mt-3 flex flex-wrap gap-2">
              <button class="subTabBtn btn rounded-lg px-3 py-2 text-sm font-semibold subtab-on" data-sub="sliders">Sliders</button>
              <button class="subTabBtn btn rounded-lg px-3 py-2 text-sm font-semibold" data-sub="performance">Performance</button>
              <button class="subTabBtn btn rounded-lg px-3 py-2 text-sm font-semibold" data-sub="recovery">Recovery</button>
              <button class="subTabBtn btn rounded-lg px-3 py-2 text-sm font-semibold" data-sub="penalties">Penalties</button>
            </div>

            <div id="builders-sliders" class="mt-4">...</div>
            <div id="builders-performance" class="mt-4 hidden">...</div>

            <div id="builders-recovery" class="mt-4 hidden">
              <div class="card rounded-xl p-4">
                <div class="flex items-start justify-between gap-3">
                  <div>
                    <div class="text-sky-200 text-lg font-semibold">Recovery Builder</div>
                    <div class="text-blue-200/70 text-sm">Select rows. Add selected to dashboard.</div>
                  </div>
                  <div class="flex gap-2">
                    <button id="btnAddRecItem" class="btn btn-primary rounded-lg px-3 py-2 text-sm font-semibold text-white">Add Item</button>
                    <button id="btnAddSelectedRecToDash" class="btn rounded-lg px-3 py-2 text-sm font-semibold">Add Selected to Dashboard</button>
                  </div>
                </div>
                <div class="mt-3 overflow-x-auto">
                  <table class="w-full text-sm">
                    <thead class="text-blue-200/80">
                      <tr>
                        <th class="text-left py-2 pr-2">Select</th>
                        <th class="text-left py-2 px-2">Order</th>
                        <th class="text-left py-2 px-2">Name</th>
                        <th class="text-right py-2 px-2">Weight</th>
                        <th class="text-left py-2 px-2">Impact</th>
                        <th class="text-left py-2 px-2">On Dash</th>
                        <th class="text-right py-2 pl-2">Actions</th>
                      </tr>
                    </thead>
                    <tbody id="recoveryBuilderTable"></tbody>
                  </table>
                </div>
              </div>
            </div>

            <div id="builders-penalties" class="mt-4 hidden">...</div>
          </div>
        </section>
      </div>
    </main>
  </div>

  <nav class="bottom-nav">
    <div class="mx-auto max-w-6xl px-3 py-2 flex gap-2">
      <button class="tabBtn btn rounded-lg px-3 py-2 text-sm tab-on" data-tab="dashboard">Dashboard</button>
      <button class="tabBtn btn rounded-lg px-3 py-2 text-sm" data-tab="builders">Builders</button>
    </div>
  </nav>

  <script>
  (function(){
    const $ = (id) => document.getElementById(id);
    const clamp = (v, min, max) => Math.min(max, Math.max(min, v));
    const escapeHtml = (s) => String(s).replace(/[&<>"']/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
    const isoDate = (d) => new Date(d.getTime() - d.getTimezoneOffset() * 60000).toISOString().slice(0,10);

    // D2) BASE LISTS
    function baseRecoveryToggles(){
      return [
        { id:"nsdr", name:"NSDR or Nap", type:"toggle", recoveryWeight:12, impact:"recovery", onDashboard:true, order:1 },
        { id:"breathwork", name:"Breathwork", type:"toggle", recoveryWeight:10, impact:"recovery", onDashboard:true, order:2 },
        { id:"mobility", name:"Mobility Flow", type:"toggle", recoveryWeight:10, impact:"recovery", onDashboard:true, order:3 },
        { id:"sauna", name:"Sauna", type:"toggle", recoveryWeight:8, impact:"recovery", onDashboard:true, order:4 },
        { id:"cold", name:"Cold Exposure", type:"toggle", recoveryWeight:6, impact:"recovery", onDashboard:true, order:5 },
        { id:"journaling", name:"Journaling", type:"toggle", recoveryWeight:6, impact:"recovery", onDashboard:true, order:6 }
      ];
    }

    function recoveryPlaceholders(startOrder){
      const names = ["Massage", "Red Light", "Hot Bath", "Meditation", "Walk", "Electrolytes", "Wind-Down", "Blue Blockers", "Quiet Hour", "Therapy"];
      return names.map((name, i)=>({ id: "rc_ext_" + i, name, type:"toggle", recoveryWeight:6, impact:"recovery", onDashboard:false, order:startOrder + i }));
    }

    // D1) DEFAULT STATE
    const defaultState = {
      tab: "dashboard",
      date: isoDate(new Date()),
      personalizationMode: false,
      catalogs: {
        sliders: [], // existing
        perf: [],    // existing
        rec: [...baseRecoveryToggles(), ...recoveryPlaceholders(100)],
        pen: []      // existing
      },
      selected: { sliders:[], perf:[], rec:[], pen:[] },
      builderSelected: { sliders:[], perf:[], rec:[], pen:[] },
      sliderValues: {}, toggles: {}, penalties: {}, history: {}
    };

    let state = loadState();

    function reviveSets(s){
      s.selected = { 
        sliders: new Set(s.selected?.sliders || []), 
        perf: new Set(s.selected?.perf || []), 
        rec: new Set(s.selected?.rec || []), 
        pen: new Set(s.selected?.pen || []) 
      };
      s.builderSelected = { 
        sliders: new Set(s.builderSelected?.sliders || []), 
        perf: new Set(s.builderSelected?.perf || []), 
        rec: new Set(s.builderSelected?.rec || []), 
        pen: new Set(s.builderSelected?.pen || []) 
      };
      return s;
    }

    function stripSetsForSave(s){
      return { ...s, 
        selected: { sliders:[...s.selected.sliders], perf:[...s.selected.perf], rec:[...s.selected.rec], pen:[...s.selected.pen] },
        builderSelected: { sliders:[...s.builderSelected.sliders], perf:[...s.builderSelected.perf], rec:[...s.builderSelected.rec], pen:[...s.builderSelected.pen] }
      };
    }

    function hydrate(s){
      s.catalogs.rec.forEach(item => { if (s.toggles[item.id] === undefined) s.toggles[item.id] = 0; });
      // ... hydrate others ...
      return s;
    }

    // D4) DASHBOARD RENDERING
    function renderRecoveryToggles(){
      const wrap = $("recoveryToggles");
      if (!wrap) return;
      wrap.innerHTML = "";
      const items = state.catalogs.rec.filter(x=>x.onDashboard).sort((a,b)=>a.order-b.order);
      items.forEach(item=>{
        const on = !!state.toggles[item.id];
        const btn = document.createElement("button");
        btn.className = `rounded-xl px-3 py-3 text-left text-sm font-semibold chip ${on?'chip-on':''} ${state.personalizationMode && state.selected.rec.has(item.id)?'selected-outline':''}`;
        btn.innerHTML = `<div class="text-sky-200">${escapeHtml(item.name)}</div><div class="text-blue-200/70 text-xs">Rec ${item.recoveryWeight}</div>`;
        btn.onclick = () => {
          if(state.personalizationMode){
            state.selected.rec.has(item.id) ? state.selected.rec.delete(item.id) : state.selected.rec.add(item.id);
          } else {
            state.toggles[item.id] = on ? 0 : 1;
            recalc();
          }
          renderRecoveryToggles();
          saveState();
        };
        wrap.appendChild(btn);
      });
    }

    // D5) MOVE HANDLER
    $("btnMoveRecovery").onclick = async () => {
      if(!state.personalizationMode) return;
      state.selected.rec.forEach(id => { const item = state.catalogs.rec.find(x=>x.id===id); if(item) item.onDashboard = false; });
      state.selected.rec.clear();
      renderDashboard();
      renderBuilders();
      saveState();
    };

    // D10) SCORING ENGINE UPDATE
    function computeRecoveryWeightsNormalized(){
      const contributors = [];
      // ... Existing loops for sliders and perf ...
      state.catalogs.rec.forEach(item=>{
        if ((item.impact === "recovery" || item.impact === "both") && Number(item.recoveryWeight) > 0) contributors.push(item);
      });
      // ... Continue normalized calculation ...
    }

    // ... Other functions like renderRecoveryBuilder, addSelectedToDashboard (rec), etc. as per patches ...
    
    function init(){
      // ... init listeners ...
      renderDashboard();
    }
    init();
  })();
  </script>
</body>
</html>
